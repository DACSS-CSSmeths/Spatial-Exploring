
<br> 
<center><img src="https://github.com/DACSS-CSSmeths/guidelines/blob/main/pics/small_logo_ccs_meths.jpg?raw=true" width="700"></center>


_____



# Exploring spatial data

Let me bring the file we created in Python:

```{r}
rm(list = ls())
library(sf)

mainLink='https://github.com/DACSS-CSSmeths/Spatial-Exploring/raw/refs/heads/main/'
mapLink=paste0(mainLink,'maps/countriesCIA.gpkg')


countriesCIA=read_sf(mapLink, layer='cia')
worldMap=read_sf(mapLink, layer='border')


##we have

head(countriesCIA)
```



```{r}
library(ggplot2)

base=ggplot(data = worldMap)+geom_sf(fill='grey',color=NA) + theme_linedraw()
base + geom_sf(data=countriesCIA,
               aes(fill=tobacco_perc), #variable for coloring geometry
               color=NA) + # no borders
    labs(fill="Tobacco use\n(grey = missing)") +
    scale_fill_viridis_c(direction = 1,option='A') # color map
```


Let's plot a diverging palette (choose from [here](https://ggplot2.tidyverse.org/reference/scale_brewer.html)) using the discrete version:

```{r}


base + geom_sf(data=countriesCIA,
               aes(fill=tobacco_levels),color=NA) + 
               labs(fill="Level",
                    title='Tobaco use')+
                    scale_fill_brewer(palette = "PiYG",direction = -1) 

```

```{r}
customCols=c("green", "orange")
base + geom_sf(data=countriesCIA[countriesCIA$tobacco_code%in%c(0,2),],
               aes(fill=tobacco_levels),color=NA) + 
               labs(fill="Level",
                    title='Tobaco use')+
                    scale_fill_manual(values = customCols)+
    facet_grid(~tobacco_levels) + guides(fill="none")
```

```{r}
countriesCIA_worstTobAlc=countriesCIA[(countriesCIA$tobacco_code==4) & (countriesCIA$alcohol_code==4),]
countriesCIA_worstTobAlc
```
```{r}
bbox=as.vector(st_bbox(countriesCIA_worstTobAlc))

base + geom_sf(data=countriesCIA_worstTobAlc,fill='red') + 
  coord_sf(xlim = c(bbox[1],bbox[3]), ylim = c(bbox[2],bbox[4])) +
    geom_sf_text(data=countriesCIA_worstTobAlc,
                 aes(label=COUNTRY),
                 check_overlap = T,
                 size=3,
                 nudge_y = 0.15)
```



# Interactive maps

We will use **leaflet** library:

```{r, eval=TRUE, message=FALSE, warning=FALSE}
library(leaflet)

# create palette to fill polygons
paletteFun=colorFactor(palette = "PiYG",reverse = T, 
                       domain = countriesCIA$tobacco_levels)

#popup labels when using your cursor
popUp_labels <- sprintf("<strong>%s</strong>",
                        countriesCIA$tobacco_perc) %>% lapply(htmltools::HTML)

# the base map: the WA boundaries (optional)
base_map = leaflet() %>% 
            addTiles()
# adding a layer (main map layer)
choroAll = base_map %>%
         addPolygons(data=countriesCIA,
                     stroke = F, # borders of polygon?
                     opacity =  1, # # the closer to 0 the more transparent
                     fillOpacity = 0.8, # color brigthness
                     fillColor = ~paletteFun(tobacco_levels),# coloring
                     label = popUp_labels, 
                     labelOptions = labelOptions(
                         style = list("font-weight" = "normal"),
                         textsize = "15px",
                         direction = "auto"))


# You may need a legend:
choroAll %>% addLegend(data=countriesCIA,
                        position = "bottomright",
                        pal = paletteFun,
                        values = ~tobacco_levels,
                        title = "Level",
                        opacity = 1) 

```


* Create submaps

```{r}
# filtering
countriesCIA_good=countriesCIA[countriesCIA$tobacco_code==0,]
countriesCIA_mean=countriesCIA[countriesCIA$tobacco_code==2,]


# from the brewer website, copy and paste:
MyColors=c('green','orange')

# one layer per group

layer1= leaflet() %>% 
            addTiles() %>%
        addPolygons(data=countriesCIA_good,
                    color=MyColors[1],
                    fillOpacity = 1, # no transparency
                    stroke = F,
                    group = 'good') # LAYER as GROUP

layer1_2= layer1%>%addPolygons(data=countriesCIA_mean,
                               color=MyColors[2],
                               fillOpacity = 0.5, # transparency!!!
                               stroke = F,
                               group = 'average')

# Let's add a _button_ that helps rezooming:


textFun="function(btn, map){map.setView([47.751076, -120.740135], 7)}"

finalZoom= layer1_2%>%
    addEasyButton(
        easyButton(icon="fa-home", # a symbol
                   title="Zoom to Level 1",
                   onClick=JS(textFun)))


finalZoomLayers=finalZoom %>% addLayersControl(
        overlayGroups = c('good','average'),
        options = layersControlOptions(collapsed = FALSE))
finalZoomLayers
```

```{r}

leaflet() %>% 
            addTiles() %>%
        addPolygons(data=countriesCIA_worstTobAlc) # LAYER as GROUP
```


_____

<a id='part6'></a>

## Deliverable III (option 1)

This link has data from this [website](https://www.ocpf.us/Home/Index), which, similarly to our previous data, campaign and political finances. This data has a subsample for Boston.
```{r}
linkBoston="https://github.com/DACSS-Visual/SpatialData/raw/refs/heads/main/data/BostonContrib.xlsx"

bostonCont=rio::import(linkBoston)

#see it
head(bostonCont)
```

And you have this map of zip codes:

```{r}
library(sf)
linkZips='https://raw.githubusercontent.com/DACSS-Visual/SpatialData/refs/heads/main/data/zip_codes.json'
bostonZips=sf::read_sf(linkZips)
#see it
head(bostonZips)
```

```{r}
plot(bostonZips[2])
```

You have this variable:
```{r}
summary(bostonCont$Amount)
```


```{r}
tapply(bostonCont$Amount,bostonCont$`Tender Type Description`,summary)
```

Compare the contributions of **two** tender types (you choose which), by zip zode. The results can be interactive, but it is _NOT_ compulsory.

**NOTE**: You need to aggregate the data from the excel file, and then merged that aggregated data into the map. Then, you can plot the choropleths with the data as it is (countinuous) or discretize it before plotting. 



_____

[Go to table of contents.](#TOC)



